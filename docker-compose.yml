version: '3.9'

services:
  app:
    build: ./server
    volumes:
      - ./server:/usr/src/server
      - /usr/src/server/node_modules
    ports:
      - '3001:3001' # map port 3001 on the host to port 3001 on the container
    environment:
      - DEBUG=True
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - JWT_SECRET=${JWT_SECRET}
      - PUBLIC_VAPID_KEY=${PUBLIC_VAPID_KEY}
      - PRIVATE_VAPID_KEY=${PRIVATE_VAPID_KEY}
      - WEB_PUSH_CONTACT="sender@example.com"
      - IOS_DRIVER_ARN=${IOS_DRIVER_ARN}
      - IOS_RIDER_ARN=${IOS_RIDER_ARN}
      - ANDROID_ARN=${ANDROID_ARN}
      - HOSTNAME=${HOSTNAME}
      - USE_HOSTNAME=false
    restart: always
    networks:
      - networkone
  frontend:
    build: ./frontend
    ports:
      - '3000:3000'
    environment:
      - REACT_APP_CLIENT_ID=${REACT_APP_CLIENT_ID}
      - REACT_APP_PUBLIC_VAPID_KEY=${REACT_APP_PUBLIC_VAPID_KEY}
      - REACT_APP_ENCRYPTION_KEY=${REACT_APP_ENCRYPTION_KEY}
      - CHOKIDAR_USEPOLLING=true
      - DOMAIN=${DOMAIN}
    depends_on:
      - app
    volumes:
      - ./frontend/certbot:/etc/letsencrypt
      - ./frontend/certbot/www:/var/www/certbot/
      - build-data:/usr/src/frontend/build
    networks:
      - networkone
  web:
    image: nginx:stable-alpine
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./frontend/certbot:/etc/letsencrypt
      - ./frontend/certbot/www:/var/www/certbot/
      - ./frontend/default.conf:/etc/nginx/conf.d/my-site.conf.template
      - build-data:/usr/share/nginx/html
    environment:
      - DOMAIN=${DOMAIN}
    command: /bin/sh -c "envsubst '$${DOMAIN}'< /etc/nginx/conf.d/my-site.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    depends_on:
      - frontend
    restart: always
    networks:
      - networkone
  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./frontend/certbot:/etc/letsencrypt
      - ./frontend/certbot/www:/var/www/certbot/
    networks:
      - networkone
networks:
  networkone:
volumes:
  build-data:
